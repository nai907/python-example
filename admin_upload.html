<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SPVC Prediction Online Platform</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='icon.ico') }}" />
</head>
<body>

  <!-- Flash Messages -->
  <div id="flashMessages" style="display: none;">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div id="flashMessageContent">
          {% for message in messages %}
            <p>{{ message }}</p>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
  </div>

  <!-- User Type Modal -->
  <div class="modal" id="userTypeModal" tabindex="-1" aria-labelledby="userTypeModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="userTypeModalLabel">SPVC Prediction Online Platform</h5>
        </div>
        <div class="modal-body">
          <p>Please select options.</p>
          <div class="d-flex flex-column mt-3">
            <!-- Buttons for user type selection -->
            <button type="button" class="btn btn-primary mb-2" id="generalUserButton">General user</button>
            <button type="button" class="btn btn-secondary mb-2" id="advancedUserButton">Advanced user</button>
            <!-- Link to download result -->
            <a type="button" href="/plots" class="btn btn-success mb-2">Download Result</a>
            {% if session.get('role') == 'Admin' %}
              <!-- Admin upload button, visible only for admins -->
              <button type="button" class="btn btn-warning mb-2" data-bs-toggle="modal" data-bs-target="#uploadConfirmModal">Admin Upload</button>
            {% endif %}
            <!-- Logout button -->
            <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload Confirm Modal -->
  <div class="modal fade" id="uploadConfirmModal" tabindex="-1" aria-labelledby="uploadConfirmModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadConfirmModalLabel">Confirm Upload</h5>
        </div>
        <div class="modal-body">
          Are you sure you want to upload and replace reactor_pilot.exe?
          <!-- Upload form -->
          <form id="uploadForm" method="POST" enctype="multipart/form-data" action="{{ url_for('admin_upload') }}">
            <div class="mb-3">
              <label for="file" class="form-label">Choose file to upload</label>
              <input type="file" class="form-control" id="file" name="file" accept=".exe" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="cancelUploadButton">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmUploadButton">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Warning Modal -->
  <div class="modal fade" id="warningModal" tabindex="-1" aria-labelledby="warningModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="warningModalLabel">Warning</h5>
        </div>
        <div class="modal-body">
          You are about to upload a new .exe file. Are you sure you want to proceed?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="warningCancelButton">Cancel</button>
          <button type="button" class="btn btn-danger" id="finalConfirmButton">Proceed</button>
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery and Bootstrap Bundle (includes Popper) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    $(document).ready(function() {
      // Show user type modal on page load
      $('#userTypeModal').modal('show');

      // Show flash messages alert if there are any messages
      if ($('#flashMessageContent').length) {
        const messages = $('#flashMessageContent').html().trim().split('</p>');
        messages.forEach(message => {
          if (message) {
            alert(message.replace('<p>', '').trim());
          }
        });
      }

      // Redirect to general user page
      $('#generalUserButton').click(function() {
        window.location.href = '/general_user';
      });

      // Redirect to advanced user page
      $('#advancedUserButton').click(function() {
        window.location.href = '/advanced_user';
      });

      // Confirm upload button click event
      $('#confirmUploadButton').click(function() {
        const fileInput = $('#file')[0];
        const filePath = fileInput.value;
        const allowedExtensions = /(\.exe)$/i;

        if (!allowedExtensions.exec(filePath)) {
          alert('Please upload a file with .exe extension.');
          fileInput.value = '';
        } else {
          $('#userTypeModal').modal('hide');
          $('#warningModal').modal('show');
        }
      });

      // Final confirm button click event
      $('#finalConfirmButton').click(function() {
        $('#uploadForm').submit();
      });

      // Cancel upload button click event
      $('#cancelUploadButton').click(function() {
        $('#uploadConfirmModal').modal('hide');
        $('#userTypeModal').modal('show');
      });

      // Hide user type modal when upload confirm modal is shown
      $('#uploadConfirmModal').on('show.bs.modal', function() {
        $('#userTypeModal').modal('hide');
      });

      // Hide user type and upload confirm modals when warning modal is shown
      $('#warningModal').on('show.bs.modal', function() {
        $('#userTypeModal').modal('hide');
        $('#uploadConfirmModal').modal('hide');
      });

      // Show user type modal when warning cancel button is clicked
      $('#warningCancelButton').click(function() {
        $('#warningModal').modal('hide');
        $('#userTypeModal').modal('show');
      });
    });
  </script>
</body>
</html>
